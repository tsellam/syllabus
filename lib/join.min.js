function randInt(n,e){return n=Math.ceil(n),e=Math.floor(e),Math.floor(Math.random()*(e-n))+n}function randBool(){return Math.random()>=.5}function randExp(){return Math.pow(10,randInt(1,6))}function randItem(n){return n[randInt(0,n.length-1)]}function genTable(n){var e=randBool(),t=randBool(),r=randBool();return{name:n,npages:randExp(),hash:e,ptree:t,stree:r}}function genStats(n){var e=randItem(n.tupsizes);return{fillfactor:randItem(n.fillfactors),desize:randItem(n.desizes),tupsize:e,pagesize:e*randItem(n.tupsperpage)}}function log(n,e){return Math.log(e)/Math.log(n)}function solve(n,e){_.each(n,function(n){accessCosts(n,e)});var t={},r={},a=[];for(_.each(n,function(t){_.each(n,function(n){if(t!=n){var a=joinCost(t,n,e);if(_.isUndefined(r.cost)||a.cost<r.cost){var o=Math.ceil(_.min([t.card,n.card])*e.tupsize/(e.fillfactor*e.pagesize));a.npages=o,r=a}}})}),t[r.outer.name]=1,t[r.inner.name]=1,a.push(r);_.size(t)<n.length;){var o=_.compact(_.map(n,function(n){if(!(n.name in t))return joinCost(r,n,e)})),i=_.min(o,function(n){return n.cost}),s=_.min([r.card,i.inner.card]),c=Math.ceil(s*e.tupsize/(e.fillfactor*e.pagesize));r={outer:r,inner:i.inner,jointype:i.jointype,cost:i.cost,npages:c,card:_.min([r.card,i.inner.card])},a.push(_.clone(r)),t[i.inner.name]=1}return{bestJoin:r,choices:a}}function linearizeJoinTree(n){for(var e=[];!_.isUndefined(n)&&n.inner;)e.push(n.inner.name),e.push(n.jointype),n=n.outer;return e.push(n.name),e.reverse()}function accessCosts(n,e){if(n.card=Math.floor(n.npages*Math.floor(e.fillfactor*e.pagesize/e.tupsize)),n.hash&&(n.hashCost=1),n.ptree){var t=Math.ceil(log(e.fillfactor*e.pagesize/e.desize,n.npages));n.ptreeCost=t+1}if(n.stree){var r=Math.floor(e.fillfactor*e.pagesize/e.tupsize),a=Math.floor(e.fillfactor*e.pagesize/e.desize),t=Math.ceil(log(a,Math.ceil(n.npages*r/a)));n.ptreeCost=t+1+1}}function joinCost(n,e,t){var r=[["Hash-INL",e.hashCost],["Primary-BTree-INL",e.ptreeCost],["Sec-BTree-INL",e.streeCost],["NL",e.npages],["HashJoin",1]],a=n.cost||n.npages;r=_.reject(r,function(n){return _.isNaN(n[1])||_.isUndefined(n[1])}),r=_.map(r,function(t){return"HashJoin"==t[0]?[t[0],a+e.npages+n.card*t[1]]:[t[0],a+n.card*t[1]]});var o=_.min(r,function(n){return n[1]});return{inner:e,outer:n,jointype:o[0],cost:o[1],card:_.min([n.card,e.card])}}function genProblem(n){var e=_.times(4,function(e){return genTable("T"+(e+1),n)}),t=genStats(n),r=solve(e,t),a=r.bestJoin,o=r.choices;$("#problem").html(genHTML("#entry-template",{tables:e,stats:t}));var i=[o[0].outer.name];_.each(o,function(n){i.push([" ",n.jointype," ",n.inner.name,") "])}),i.unshift(_.times(o.length,function(){return"("})),i=_.flatten(i).join("");var s=[];_.each(o,function(n,e){var t="R"+e;0==e&&(t=n.outer.name),s.push({result:"R"+(e+1),outer:t,inner:n.inner.name,jointype:n.jointype,cardinality:n.card,joincost:n.cost})}),$("#solution").html(genHTML("#sol-template",{solution:i,card:a.card,cost:a.cost,joins:s})),$("#btn").click(function(){$(".sol").toggle()})}function genHTML(n,e){var t=$(n).html(),r=Handlebars.compile(t);return r(e)}
